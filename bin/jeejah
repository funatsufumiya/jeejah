#!/usr/bin/env lua

require "luarocks.loader"

local opts, host, port = {}

for n,v in ipairs(arg) do
   if(v == "--host") then
      host = arg[n+1]
   elseif(v == "--port") then
      port = arg[n+1]
   elseif(v == "--fennel") then
      local bencode = require("bencode")
      local fennel = require("fennel")
      table.insert(package.loaders, fennel.make_searcher({correlate=true}))
      local view = require("fennelview")

      -- TODO: a lot of this is duplicated from functions in jeejah.lua
      local call = function(f, argument, session)
         local old_write, old_print, old_read = io.write, print, io.read
         if(session.sandbox) then
            return f(argument, {env=session.sandbox})
         else
            _G.print = function(...)
               for _,x in ipairs({...}) do session.write(x) end
               session.write("\n")
            end
            _G.io.write, _G.io.read = session.write, session.read
         end

         local trace, err
         local results = {xpcall(function() return f(argument) end,
                                function(e)
                                   trace = debug.traceback()
                                   err = e end)}
         _G.print, _G.io.write, _G.io.read = old_print, old_write, old_read
         if(table.remove(results, 1)) then
            local out = {}
            for i, res in ipairs(results) do out[i] = view(res) end
            return table.concat(out, "\t")
         else
            return nil, (err or "Unknown error") .. "\n" .. trace
         end
      end
      local response_for = function(old_msg, msg)
         msg.session, msg.id, msg.ns = old_msg.session, old_msg.id, ""
         return msg
      end

      opts.handlers = {
         ["load-file"] = function(conn, msg, session)
            local value, err = call(fennel.dofile, msg.file, session)
            conn:send(bencode.encode(response_for(msg, {value=value, ex=err})))
            conn:send(bencode.encode(response_for(msg, {status="done"})))
         end,
         eval = function(conn, msg, session)
            local value, err = call(fennel.eval, msg.code, session)
            conn:send(bencode.encode(response_for(msg, {value=value, ex=err})))
            conn:send(bencode.encode(response_for(msg, {status="done"})))
         end,
      }
   elseif(v == "--debug") then
      opts.debug = true
   elseif(v == "--empty-sandbox") then
      opts.sandbox = {}
   elseif(v == "--version" or v == "--help") then
      print("jeejah 0.2.0\n")
      print("Options:")
      print("  --host    Hostname on which to listen")
      print("  --port    Port on which to listen")
      print("  --debug   Print verbose debugging information")
      os.exit(0)
   end
end

local root_dir = debug.getinfo(1).source:sub(2, -(1+#"bin/jeejah"))
local jeejah = dofile(root_dir .. "jeejah.lua")
local coro = jeejah.start(host, port, opts)
while true do coroutine.resume(coro) end
